rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isEmailVerified() {
      return isAuthenticated() && request.auth.token.email_verified == true;
    }

    function isAgeVerified() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ageVerified == true &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.age >= 18;
    }

    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for discovery/search)
      allow read: if isAuthenticated();

      // Users can create their own profile during signup
      allow create: if isOwner(userId) &&
        request.resource.data.email == request.auth.token.email &&
        request.resource.data.uid == userId &&
        request.resource.data.role == 'user' && // Cannot set yourself as admin
        request.resource.data.ageVerified == true && // Must be age verified
        request.resource.data.age >= 18 && // Must be 18+
        request.resource.data.emailVerified == false && // Initially false
        request.resource.data.keys().hasAll(['email', 'displayName', 'zipCode', 'dateOfBirth', 'age', 'ageVerified', 'role', 'emailVerified', 'createdAt', 'updatedAt']);

      // Users can update their own profile (but not certain protected fields)
      allow update: if isOwner(userId) &&
        // Protected fields that cannot be changed
        request.resource.data.uid == resource.data.uid &&
        request.resource.data.email == resource.data.email &&
        request.resource.data.role == resource.data.role &&
        request.resource.data.ageVerified == resource.data.ageVerified &&
        request.resource.data.age == resource.data.age &&
        request.resource.data.dateOfBirth == resource.data.dateOfBirth &&
        request.resource.data.createdAt == resource.data.createdAt &&
        // Ensure emailVerified can only go from false to true (via Firebase Auth)
        (request.resource.data.emailVerified == resource.data.emailVerified ||
         (resource.data.emailVerified == false && request.resource.data.emailVerified == true)) &&
        // Profile fields validations (Sprint 2)
        (request.resource.data.displayName is string && request.resource.data.displayName.size() >= 2 && request.resource.data.displayName.size() <= 50) &&
        (request.resource.data.zipCode is string && request.resource.data.zipCode.matches('^[0-9]{5}$')) &&
        (!('bio' in request.resource.data) || (request.resource.data.bio is string && request.resource.data.bio.size() <= 500)) &&
        (!('interests' in request.resource.data) || (request.resource.data.interests is list && request.resource.data.interests.size() >= 3 && request.resource.data.interests.size() <= 20)) &&
        (!('photoURL' in request.resource.data) || request.resource.data.photoURL is string) &&
        // verificationStatus can only be changed by admins (via separate admin function)
        (!('verificationStatus' in request.resource.data) || request.resource.data.verificationStatus == resource.data.verificationStatus);

      // Users can delete their own profile
      allow delete: if isOwner(userId);
    }

    // Verification requests collection (Sprint 2)
    match /verificationRequests/{requestId} {
      // Only admins can read verification requests
      allow read: if isAdmin();

      // Users can create verification requests for themselves
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.status == 'pending' &&
        request.resource.data.keys().hasAll(['userId', 'userEmail', 'userName', 'notes', 'status', 'createdAt']);

      // Only admins can update verification requests (to approve/reject)
      allow update: if isAdmin();

      // Only admins can delete verification requests
      allow delete: if isAdmin();
    }

    // Posts collection (Sprint 2+)
    match /posts/{postId} {
      // Anyone authenticated and age verified can read posts
      allow read: if isAuthenticated() && isAgeVerified();

      // Email verified and age verified users can create posts
      allow create: if isEmailVerified() && isAgeVerified() &&
        request.resource.data.authorId == request.auth.uid &&
        request.resource.data.keys().hasAll(['authorId', 'content', 'createdAt', 'updatedAt']);

      // Post author can update their own posts (not authorId)
      allow update: if isEmailVerified() && isAgeVerified() &&
        resource.data.authorId == request.auth.uid &&
        request.resource.data.authorId == resource.data.authorId;

      // Post author or admin can delete
      allow delete: if isAuthenticated() && isAgeVerified() &&
        (resource.data.authorId == request.auth.uid || isAdmin());

      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isAuthenticated() && isAgeVerified();
        allow create: if isEmailVerified() && isAgeVerified() &&
          request.resource.data.authorId == request.auth.uid;
        allow update: if isEmailVerified() && isAgeVerified() &&
          resource.data.authorId == request.auth.uid &&
          request.resource.data.authorId == resource.data.authorId;
        allow delete: if isAuthenticated() && isAgeVerified() &&
          (resource.data.authorId == request.auth.uid || isAdmin());
      }

      // Reactions subcollection
      match /reactions/{reactionId} {
        allow read: if isAuthenticated() && isAgeVerified();
        allow create: if isEmailVerified() && isAgeVerified() &&
          reactionId == request.auth.uid; // Reaction ID is user ID
        allow delete: if isAuthenticated() && isAgeVerified() &&
          reactionId == request.auth.uid;
      }
    }

    // Messages collection (Sprint 3+)
    match /conversations/{conversationId} {
      // Can read if you're a participant
      allow read: if isAuthenticated() && isAgeVerified() &&
        request.auth.uid in resource.data.participantIds;

      // Can create if you're a participant and email verified
      allow create: if isEmailVerified() && isAgeVerified() &&
        request.auth.uid in request.resource.data.participantIds &&
        request.resource.data.participantIds.size() == 2; // 1-on-1 conversations only

      // Can update if you're a participant (for read receipts, etc.)
      allow update: if isEmailVerified() && isAgeVerified() &&
        request.auth.uid in resource.data.participantIds;

      match /messages/{messageId} {
        allow read: if isAuthenticated() && isAgeVerified() &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
        allow create: if isEmailVerified() && isAgeVerified() &&
          request.resource.data.senderId == request.auth.uid &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
      }
    }

    // Notifications collection (Sprint 3+)
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && isAgeVerified() &&
        resource.data.userId == request.auth.uid;

      // Users can update their own notifications (to mark as read)
      allow update: if isAuthenticated() && isAgeVerified() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == resource.data.userId;

      // Users can delete their own notifications
      allow delete: if isAuthenticated() && isAgeVerified() &&
        resource.data.userId == request.auth.uid;
    }

    // Connections collection (Sprint 3)
    match /connections/{connectionId} {
      // Users can read connections they're part of
      allow read: if isAuthenticated() && isAgeVerified() &&
        (resource.data.fromUserId == request.auth.uid ||
         resource.data.toUserId == request.auth.uid);

      // Email verified and age verified users can create connection requests
      allow create: if isEmailVerified() && isAgeVerified() &&
        request.resource.data.fromUserId == request.auth.uid &&
        request.resource.data.status == 'pending' &&
        request.resource.data.keys().hasAll(['fromUserId', 'toUserId', 'status', 'createdAt', 'updatedAt']);

      // Users can update connections they're the recipient of (to accept/decline)
      allow update: if isEmailVerified() && isAgeVerified() &&
        resource.data.toUserId == request.auth.uid &&
        resource.data.fromUserId == request.resource.data.fromUserId &&
        resource.data.toUserId == request.resource.data.toUserId &&
        (request.resource.data.status == 'accepted' || request.resource.data.status == 'declined');

      // Users can delete connections they're part of
      allow delete: if isAuthenticated() && isAgeVerified() &&
        (resource.data.fromUserId == request.auth.uid ||
         resource.data.toUserId == request.auth.uid);
    }

    // Profiles collection (Sprint 2+)
    match /profiles/{profileId} {
      // Anyone authenticated can read public profiles (for search)
      allow read: if isAuthenticated();

      // Users can create their own profile
      allow create: if isOwner(profileId) &&
        request.resource.data.uid == profileId;

      // Users can update their own profile
      allow update: if isOwner(profileId) &&
        request.resource.data.uid == resource.data.uid;

      // Users can delete their own profile
      allow delete: if isOwner(profileId);
    }

    // Default deny all other documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
